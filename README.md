# AVITO PVZ Test

Сервис для управления пунктами выдачи заказов (ПВЗ) с возможностью создания приемок и управления товарами.

## Требования

- Go 1.21 или выше
- Docker и Docker Compose
- PostgreSQL 15

## Установка и запуск

### Способ 1: Запуск через Docker 

1. Убедитесь, что Docker и Docker Compose установлены на вашей системе
2. Клонируйте репозиторий:
   ```bash
   git clone <url-репозитория>
   cd AVITO-PVZ-TEST
   ```
3. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up --build
   ```

Приложение будет доступно по адресу: http://localhost:8080
Метрики Prometheus доступны по адресу: http://localhost:9000/metrics

### Способ 2: Локальный запуск

1. Установите зависимости:
   ```bash
   go mod download
   ```

2. Запустите PostgreSQL:
   ```bash
   docker-compose up -d db
   ```

3. Запустите приложение:
   ```bash
   go run cmd/main.go
   ```

## API Endpoints

### Аутентификация
- `POST /dummyLogin` - Получение JWT токена
  ```json
  {
    "role": "employee" // или "moderator"
  }
  ```

### ПВЗ
- `GET /pvz` - Получение списка ПВЗ с приемками
  Параметры:
  - `startDate` (обязательный) - Начальная дата в формате YYYY-MM-DD
  - `endDate` (обязательный) - Конечная дата в формате YYYY-MM-DD
  - `page` (опциональный) - Номер страницы (по умолчанию 1)
  - `limit` (опциональный) - Количество записей на странице (по умолчанию 10)

### Приемки
- `POST /reception` - Создание новой приемки
  ```json
  {
    "pvz_id": "uuid",
    "date_time": "2024-03-20T10:00:00Z"
  }
  ```

- `POST /reception/close` - Закрытие приемки
  ```json
  {
    "reception_id": "uuid"
  }
  ```

### Товары
- `POST /product` - Добавление товара
  ```json
  {
    "reception_id": "uuid",
    "type": "электроника" // или "одежда", или "обувь"
  }
  ```

- `DELETE /product/{id}` - Удаление товара

## Тестирование

Для запуска тестов:
```bash
go test ./...
```

Для запуска интеграционных тестов:
```bash
go test ./internal/integration_test
```

## Мониторинг

Метрики Prometheus доступны по адресу: http://localhost:9000/metrics

## Конфигурация

Основные настройки находятся в файле `configs/config.yaml`. Для переопределения настроек можно использовать переменные окружения:

- `SERVER_PORT` - Порт сервера (по умолчанию 8080)
- `DB_HOST` - Хост базы данных
- `DB_PORT` - Порт базы данных
- `DB_USER` - Пользователь базы данных
- `DB_PASSWORD` - Пароль базы данных
- `DB_NAME` - Имя базы данных
- `JWT_SECRET` - Секрет для JWT токенов

## Проблемы и их решения

Вот какие проблемы я встретил во время разработки и как я их решил:

### 1. Проблема с версией Go
**Что случилось**: При попытке собрать Docker-образ вылетала ошибка, потому что версия Go в моем проекте не совпадала с версией в Dockerfile.
**Как решил**: Просто поменял версию Go в Dockerfile на ту, которая установлена у меня на компьютере (1.24).

### 2. Проблема с инициализацией репозитория
**Что случилось**: Программа не запускалась, потому что я неправильно назвал функцию для создания репозитория.
**Как решил**: Нашел правильное название функции в коде (`NewRepository`) и исправил его в `main.go`.

### 3. Проблема с авторизацией
**Что случилось**: При попытке авторизоваться вылетала ошибка, потому что программа не могла найти JWT секрет.
**Как решил**: Проверил структуру конфигурации и исправил путь к секрету.

### 4. Проблема с Docker
**Что случилось**: Docker не был установлен на моем компьютере.
**Как решил**: Установил Docker Desktop для macOS и добавил инструкции по установке в документацию.

### 5. Проблема с миграцией базы данных
**Что случилось**: При запуске программы база данных не инициализировалась правильно.
**Как решил**: Добавил проверку ошибок и логирование, чтобы видеть, что происходит при миграции.

### 6. Проблема с конфигурацией сервера
**Что случилось**: Сервер работал медленно и не выдерживал нагрузку.
**Как решил**: 
- Установил таймауты для чтения и записи в 50 мс
- Настроил пул соединений с базой данных
- Добавил кэширование часто используемых данных

### 7. Проблема с ролями пользователей
**Что случилось**: В API и базе данных использовались разные названия ролей.
**Как решил**: 
- Заменил роль `client` на `employee`
- Обновил проверки ролей в middleware
- Написал тесты для проверки

### 8. Проблема с производительностью
**Что случилось**: При большом количестве запросов сервер начинал тормозить.
**Как решил**:
- Добавил кэширование часто запрашиваемых данных
- Оптимизировал запросы к базе данных
- Настроил пул соединений
- Добавил мониторинг через Prometheus

### 9. Проблема с тестированием
**Что случилось**: Было сложно тестировать взаимодействие разных частей программы.
**Как решил**:
- Создал мок-репозиторий для тестов
- Написал интеграционные тесты
- Добавил тесты для проверки граничных случаев

### 10. Проблема с обработкой ошибок
**Что случилось**: Сообщения об ошибках были непонятными.
**Как решил**:
- Добавил подробное логирование
- Сделал ошибки более информативными
- Создал специальные типы ошибок для разных ситуаций

### 11. Проблема с валидацией данных
**Что случилось**: Программа принимала некорректные данные.
**Как решил**:
- Добавил проверку данных в API
- Добавил проверки в бизнес-логику
- Настроил ограничения в базе данных

### 12. Проблема с безопасностью
**Что случилось**: Нужно было защитить API от злоумышленников.
**Как решил**:
- Добавил JWT-аутентификацию
- Настроил проверку входных данных
- Добавил CORS-политики
- Ограничил количество запросов от одного пользователя 