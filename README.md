# AVITO-PVZ-TEST

Сервис для управления пунктами выдачи заказов (ПВЗ) с поддержкой HTTP и gRPC API.

## Функциональность

### ПВЗ (Пункты выдачи заказов)
- Создание нового ПВЗ
- Получение списка ПВЗ с пагинацией
- Получение ПВЗ по ID
- Обновление данных ПВЗ
- Удаление ПВЗ
- Получение списка ПВЗ с приемками за период

### Приемки
- Создание новой приемки
- Закрытие приемки
- Получение списка приемок
- Получение приемки по ID
- Получение открытой приемки для ПВЗ

### Товары
- Добавление товара в приемку
- Добавление нескольких товаров
- Удаление последнего добавленного товара
- Получение списка товаров приемки
- Поддержка различных типов товаров (электроника, одежда, обувь)

### Безопасность
- JWT аутентификация
- Ролевая модель (moderator, client)
- Защищенные эндпоинты
- Валидация входных данных

### Мониторинг
- Prometheus метрики
- Метрики HTTP запросов
- Бизнес метрики
- Метрики транзакций

## Структура проекта

```
AVITO-PVZ-TEST/
├── cmd/                    # Точки входа приложения
│   ├── api/               # API сервер
│   ├── http/              # HTTP-сервер
│   └── grpc/              # gRPC-сервер
├── configs/               # Конфигурационные файлы
├── deployments/           # Файлы для развертывания
├── api/                   # API-спецификации
│   ├── openapi/          # OpenAPI спецификация
│   └── proto/            # Protocol Buffers
├── internal/             # Внутренний код приложения
│   ├── app/             # Инициализация приложения
│   ├── config/          # Конфигурация приложения
│   ├── domain/          # Доменные модели
│   ├── handler/         # Обработчики запросов
│   ├── middleware/      # Middleware компоненты
│   ├── models/          # Модели данных
│   ├── pvz/             # Логика работы с ПВЗ
│   ├── repository/      # Репозитории
│   ├── service/         # Бизнес-логика
│   ├── usecase/         # Сценарии использования
│   └── metrics/         # Метрики
├── pkg/                  # Публичные пакеты
├── test/                 # Тесты
│   ├── integration/     # Интеграционные тесты
│   └── unit/           # Unit-тесты
├── migrations/          # Миграции базы данных
├── go.mod              # Зависимости
└── Makefile           # Скрипты сборки
```

## Требования

- Go 1.22+
- PostgreSQL 15+
- Docker и Docker Compose
- Protobuf компилятор
- Make

## Установка и запуск

1. Клонируйте репозиторий:
```bash
git clone https://github.com/avito/pvz.git
cd pvz
```

2. Создайте файл `.env` на основе `.env.example`:
```bash
cp .env.example .env
```

3. Сгенерируйте код из proto-файлов и OpenAPI схемы:
```bash
make generate
```

4. Запустите приложение с помощью Docker Compose:
```bash
docker-compose up -d
```

## API

### HTTP API

#### Аутентификация
- `POST /api/v1/register` - Регистрация пользователя
- `POST /api/v1/login` - Вход в систему
- `POST /api/v1/dummy-login` - Тестовый вход (для разработки)

#### ПВЗ
- `POST /api/v1/pvz` - Создание ПВЗ
- `GET /api/v1/pvz/{id}` - Получение ПВЗ по ID
- `GET /api/v1/pvz` - Получение списка ПВЗ
- `PUT /api/v1/pvz/{id}` - Обновление ПВЗ
- `DELETE /api/v1/pvz/{id}` - Удаление ПВЗ
- `GET /api/v1/pvz/with-receptions` - Получение списка ПВЗ с приемками

#### Приемки
- `POST /api/v1/reception` - Создание приемки
- `GET /api/v1/reception/{id}` - Получение приемки по ID
- `POST /api/v1/reception/close` - Закрытие приемки
- `GET /api/v1/reception/open/{pvz_id}` - Получение открытой приемки
- `GET /api/v1/reception` - Получение списка приемок

#### Товары
- `POST /api/v1/product` - Добавление товара
- `POST /api/v1/product/batch` - Добавление нескольких товаров
- `DELETE /api/v1/product/last/{reception_id}` - Удаление последнего товара
- `GET /api/v1/product/{reception_id}` - Получение списка товаров приемки

### gRPC API

#### ПВЗ
- `GetAllPVZ` - Получение списка всех ПВЗ

## Метрики

Метрики доступны по адресу `http://localhost:9000/metrics`:

### HTTP метрики
- `http_requests_total` - Общее количество HTTP запросов
- `http_request_duration_seconds` - Длительность HTTP запросов

### Бизнес метрики
- `pvz_created_total` - Количество созданных ПВЗ
- `reception_created_total` - Количество созданных приемок
- `product_created_total` - Количество созданных товаров

### Метрики транзакций
- `transaction_duration_seconds` - Длительность транзакций
- `transaction_errors_total` - Количество ошибок в транзакциях

## Разработка

### Запуск тестов

В проекте реализованы различные типы тестов и команды для их запуска:

```bash
# Запуск всех тестов
make test

# Запуск только unit-тестов
make test-unit

# Запуск только интеграционных тестов
make test-integration

# Запуск тестов с подробным анализом покрытия
make test-coverage-detailed
```

#### Покрытие тестами

Текущее покрытие тестами:
- Общее покрытие: 84.5%
- Unit-тесты: 88.9%
- Интеграционные тесты: 72.0%

Для просмотра детального отчета о покрытии:
1. Запустите `make test-coverage-detailed`
2. Откройте сгенерированный файл `coverage.html` в браузере

#### Типы тестов

1. Unit-тесты (`test/unit/`):
   - Тесты моков репозиториев (88.9% покрытия)
   - Тесты сервисного слоя
   - Тесты обработчиков

2. Интеграционные тесты (`test/integration/`):
   - Полный flow работы с ПВЗ (72.0% покрытия)
   - Тесты пагинации
   - Тесты фильтрации по датам
   - Тесты обработки ошибок

### Генерация кода

```bash
# Генерация кода из proto-файлов и OpenAPI схемы
make generate

# Только генерация gRPC кода
make generate-grpc

# Только генерация OpenAPI кода
make generate-openapi
```

## Лицензия

MIT 